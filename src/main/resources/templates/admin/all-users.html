<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f9; padding: 20px; }
        h1 { text-align: center; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f1f1f1; }
        .form-control { width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .form-inline { display: flex; flex-wrap: wrap; gap: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Admin Panel</h1>

    <!-- Таблица пользователей -->
    <table id="usersTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Roles</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Форма добавления пользователя -->
    <h3>Add New User</h3>
    <form id="addUserForm" class="form-inline">
        <input type="text" id="name" class="form-control" placeholder="Name" required>
        <input type="email" id="email" class="form-control" placeholder="Email" required>
        <input type="password" id="password" class="form-control" placeholder="Password" required>
        <select id="roles" class="form-control" multiple></select>
        <button type="submit" class="btn-primary">Add</button>
    </form>
</div>

<!-- Модальное окно для редактирования -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <input type="text" id="editName" class="form-control mb-2" placeholder="Name" required>
                    <input type="email" id="editEmail" class="form-control mb-2" placeholder="Email" required>
                    <input type="password" id="editPassword" class="form-control mb-2" placeholder="Password (leave blank to keep)">
                    <select id="editRoles" class="form-control mb-2" multiple></select>
                    <button type="submit" class="btn btn-primary">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    class UserAPI {
        static async getAllUsers() {
            const response = await fetch('/api/admin/users');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }
        static async getAllRoles() {
            const response = await fetch('/api/admin/roles');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }
        static async createUser(userData) {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }
        static async updateUser(id, userData) {
            const response = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }
        static async deleteUser(id) {
            const response = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        }
    }

    // Отрисовка таблицы
    async function renderUsers() {
        const users = await UserAPI.getAllUsers();
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        users.forEach(user => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.roles.map(r => r.name).join(", ")}</td>
            <td>
                <button class="btn-warning" onclick="openEditModal(${user.id})">Edit</button>
                <button class="btn-danger" onclick="deleteUser(${user.id})">Delete</button>
            </td>
        `;
            tbody.appendChild(tr);
        });
    }

    // Отрисовка списка ролей для селекта
    async function renderRoles(selectId) {
        const roles = await UserAPI.getAllRoles();
        const select = document.getElementById(selectId);
        select.innerHTML = "";
        roles.forEach(role => {
            const option = document.createElement("option");
            option.value = role.id;
            option.textContent = role.name;
            select.appendChild(option);
        });
    }

    // Добавление пользователя
    document.getElementById("addUserForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const selectedRoles = Array.from(document.getElementById("roles").selectedOptions)
            .map(o => ({id: o.value, name: o.text}));

        const newUser = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
            roles: selectedRoles
        };

        await UserAPI.createUser(newUser);
        e.target.reset();
        await renderUsers();
    });

    // Удаление пользователя
    async function deleteUser(id) {
        if (confirm("Are you sure?")) {
            await UserAPI.deleteUser(id);
            await renderUsers();
        }
    }

    // Открыть модальное окно редактирования
    async function openEditModal(id) {
        const user = (await UserAPI.getAllUsers()).find(u => u.id === id);
        await renderRoles('editRoles');

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editName').value = user.name;
        document.getElementById('editEmail').value = user.email;

        // Выбираем текущие роли
        const editRoles = document.getElementById('editRoles');
        Array.from(editRoles.options).forEach(option => {
            option.selected = user.roles.some(r => r.id == option.value);
        });

        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
    }

    // Сохранить изменения пользователя
    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editUserId').value;
        const selectedRoles = Array.from(document.getElementById("editRoles").selectedOptions)
            .map(o => ({id: o.value, name: o.text}));

        const updatedUser = {
            name: document.getElementById('editName').value,
            email: document.getElementById('editEmail').value,
            password: document.getElementById('editPassword').value || null,
            roles: selectedRoles
        };

        await UserAPI.updateUser(id, updatedUser);
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        await renderUsers();
    });

    // Первичная загрузка
    (async function init() {
        await renderRoles('roles');
        await renderUsers();
    })();
</script>
</body>
</html>
